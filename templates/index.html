<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hasta Verileri</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .critical { background-color: #f8d7da; }
    .normal   { background-color: #d4edda; }
    .chart-container { margin-top: 40px; }
    .chart-row { display: flex; flex-wrap: wrap; gap: 20px; }
    .chart-box { flex: 1 1 calc(50% - 20px); }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mt-4">Hasta Sağlık Verileri</h1>

    <!-- Veri Tablosu -->
    <div class="table-responsive">
      <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Hasta ID</th>
            <th>Zaman</th>
            <th>Nabız</th>
            <th>Oksijen</th>
            <th>Solunum</th>
            <th>Sıcaklık</th>
            <th>EKG Ritmi</th>
            <th>Durum</th>
          </tr>
        </thead>
        <tbody>
          {% for row in data %}
          <tr class="{{ 'critical' if row.health_status|lower=='kritik' else 'normal' }}">
            <td>{{ row.id }}</td>
            <td>{{ row.patient_id }}</td>
            <td>{{ row.time }}</td>
            <td>{{ row.pulse_rate }}</td>
            <td>{{ row.oxygen_saturation }}</td>
            <td>{{ row.respiration_rate }}</td>
            <td>{{ row.temperature }}</td>
            <td>{{ row.ecg_rhythm }}</td>
            <td>{{ row.health_status }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="9" class="text-center">Veri bulunamadı.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if data %}
    <!-- Grafik Alanı -->
    <div class="chart-container">
      <h3>Vital Bulgular ve EKG Ritmi Grafikleri</h3>
      <div class="chart-row">
        <div class="chart-box">
          <h5>Nabız (bpm)</h5>
          <canvas id="pulseChart"></canvas>
        </div>
        <div class="chart-box">
          <h5>Oksijen Doygunluğu (%)</h5>
          <canvas id="spo2Chart"></canvas>
        </div>
        <div class="chart-box">
          <h5>Solunum Hızı (bpm)</h5>
          <canvas id="respChart"></canvas>
        </div>
        <div class="chart-box">
          <h5>Sıcaklık (°C)</h5>
          <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
          <h5>EKG Ritmi Dağılımı</h5>
          <canvas id="ecgChart"></canvas>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ortak etiketler (zaman ekseni)
      const labels = [{% for row in data %}'{{ row.time }}'{% if not loop.last %}, {% endif %}{% endfor %}];

      // Vital bulgular için veri setleri
      const pulseData =   [{% for row in data %}{{ row.pulse_rate }}{% if not loop.last %}, {% endif %}{% endfor %}];
      const spo2Data =    [{% for row in data %}{{ row.oxygen_saturation }}{% if not loop.last %}, {% endif %}{% endfor %}];
      const respData =    [{% for row in data %}{{ row.respiration_rate }}{% if not loop.last %}, {% endif %}{% endfor %}];
      const tempData =    [{% for row in data %}{{ row.temperature }}{% if not loop.last %}, {% endif %}{% endfor %}];

      // EKG ritmi için veri seti
      const ecgRhythms = [{% for row in data %}'{{ row.ecg_rhythm }}'{% if not loop.last %}, {% endif %}{% endfor %}];
      const ecgCounts = {};
      ecgRhythms.forEach(rhythm => {
        ecgCounts[rhythm] = (ecgCounts[rhythm] || 0) + 1;
      });
      const ecgLabels = Object.keys(ecgCounts);
      const ecgData = Object.values(ecgCounts);

      // Yardımcı fonksiyonla vital bulgular için grafik oluştur
      function createVitalChart(ctx, label, data, yLabel) {
        return new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: label,
              data: data,
              fill: true,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: 'Zaman' } },
              y: { title: { display: true, text: yLabel } }
            }
          }
        });
      }

      // EKG ritmi için bar grafiği oluştur
      function createEcgChart(ctx) {
        return new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ecgLabels,
            datasets: [{
              label: 'EKG Ritmi Sayısı',
              data: ecgData,
              backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: 'EKG Ritmi' } },
              y: { title: { display: true, text: 'Sayı' }, beginAtZero: true }
            }
          }
        });
      }

      // Grafikleri oluştur
      createVitalChart(
        document.getElementById('pulseChart').getContext('2d'),
        'Nabız (bpm)', pulseData, 'bpm'
      );
      createVitalChart(
        document.getElementById('spo2Chart').getContext('2d'),
        'Oksijen (%)', spo2Data, '%'
      );
      createVitalChart(
        document.getElementById('respChart').getContext('2d'),
        'Solunum (bpm)', respData, 'bpm'
      );
      createVitalChart(
        document.getElementById('tempChart').getContext('2d'),
        'Sıcaklık (°C)', tempData, '°C'
      );
      createEcgChart(
        document.getElementById('ecgChart').getContext('2d')
      );
    });
    </script>
    {% endif %}
  </div>
</body>
</html>